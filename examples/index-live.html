<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Sorting Desk - Live</title>
  
  <link rel="stylesheet" href="css/theme-default.css" media="screen" />
  
  <script type="text/javascript" src="lib/jquery-2.1.1.min.js"></script>

  <!-- Sorting Desk -->
  <script type="text/javascript" src="../src/main/SortingDesk.js"></script>

  <!-- API -->
  <script type="text/javascript" src="js/api/api-sorting_desk-live.js"></script>
  
  <!-- Main initialisation logic -->
  <script type="text/javascript">

  $(function () {
    var sortingDesk,
      nitems = $("#items"),
      nbins = $("#bins"),
      nloading = $("#loading"),
      height,
      secondaryBins = [
        { node_id: 100, features: { NAME: { "Irrelevant": 0 } } },
        { node_id: 101, features: { NAME: { "Rubbish": 0 } } },
        { node_id: 102, features: { NAME: { "Keep": 0 } } }
      ],
      primaryContentId = 'kb_aHR0cHM6Ly9rYi5kaWZmZW8uY29tL2FsX2FocmFt',
      secondaryContentIds;

    $(".wrapper").fadeIn();

    /* Setup AJAX UI notification before actually making any requests. */
    $(document).ajaxStart(function () { nloading.fadeIn(); } );
    $(document).ajaxStop(function () { nloading.fadeOut(); } );
    
    height = $(window).height() - nitems.offset().top - 28;
    
    nitems
      .height(height)
      .children().remove();
    
    nbins
      .height(height)
      .children().remove();

    secondaryContentIds = Api.initialise(primaryContentId, secondaryBins);
    
    $("#primary-node-id")
      .val(primaryContentId)
      .change(function () {
        var promise;
        
        secondaryContentIds = Api.initialise(primaryContentId = this.value,
                                             secondaryBins);

        if(!sortingDesk) {
          promise = $.Deferred();
          window.setTimeout(function () { promise.resolve(); }, 0);
        } else {
          promise = sortingDesk.reset();

          if(!promise) {
            throw "Failed to reset Sorting Desk's state";
            return;
          }
        }

        promise.done(function () {
          sortingDesk = SortingDesk.instantiate( {
            nodes: {
              items: nitems,
              bins: nbins,
              binDelete: $("#button-delete") /* Also used for 'dimissing' text
                                              * items that aren't/can't/won't be
                                              * sorted into a bin */
            },
            css: {                      /* This tree is optional: see
                                         * `SortingDesk.defaults' */
              primaryBinOuterWrapper: "wrapper-primary-bin-outer",
              primaryBinInnerWrapper: "wrapper-primary-bin-inner",
              secondaryBinsWrapper: "wrapper-secondary-bin",
              leftmostBin: "left"
            },
            primaryContentId: primaryContentId,
            secondaryContentIds: secondaryContentIds,
            visibleItems: 15
          }, {
            moreTexts: Api.moreTexts,
            getBinData: Api.getBinData,
            saveBinData: Api.saveBinData,
            addPrimarySubBin: Api.addPrimarySubBin,
            addSecondaryBin: Api.addSecondaryBin,
            removePrimarySubBin: Api.removePrimarySubBin,
            removeSecondaryBin: Api.removeSecondaryBin,
            renderText: Api.renderText,
            renderPrimaryBin: Api.renderPrimaryBin,
            renderPrimarySubBin: Api.renderPrimarySubBin,
            renderSecondaryBin: Api.renderSecondaryBin,
            renderAddButton: Api.renderAddButton
          } );
        } );
      } )
      .change();                  /* Force instantiation. */
  });
    </script>
</head>
<body>
  <div id="wrapper-outer">
    <div class="debug-controls">
      <label for="primary-node-id">Primary node id:&nbsp;<input id="primary-node-id" type="text" /></label>
    </div>
    <div id="wrapper-bins" class="wrapper">
      <div id="bins">
      </div>
    </div>
    <div id="wrapper-items" class="wrapper">
      <div id="items">
      </div>
    </div>
  </div>
  <div id="button-delete">X</div>
  <div id="loading">Loading...</div>
  <div id="notification"></div>
</body>
</html>